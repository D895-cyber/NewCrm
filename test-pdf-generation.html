<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF Generation for FSE Reports</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0052a3;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .report-preview {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 10px 0;
            background: white;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FSE Report PDF Generation Test</h1>
        <p>This page tests the PDF generation functionality for FSE service reports.</p>
        
        <div class="test-section">
            <h3>Test 1: Basic Report PDF Generation</h3>
            <p>Click the button below to generate a PDF from sample FSE report data:</p>
            <button onclick="testBasicPDFGeneration()">Generate Sample FSE Report PDF</button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 2: ASCOMP Report PDF Generation</h3>
            <p>Click the button below to generate a comprehensive ASCOMP-style report PDF:</p>
            <button onclick="testASCOMPPDFGeneration()">Generate ASCOMP Report PDF</button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-section">
            <h3>Sample Report Preview</h3>
            <div class="report-preview" id="report-preview">
                <div style="text-align: center; border-bottom: 2px solid #0066cc; padding-bottom: 10px; margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: bold; color: #0066cc;">ASCOMP INC.</div>
                    <div style="font-size: 10px;">9, Community Centre, 2nd Floor, Phase I, Mayapuri, New Delhi, 110064</div>
                    <div style="font-size: 10px;">Desk: 011-45501226 | Mobile: 8882475207</div>
                    <div style="font-size: 10px;">Email: helpdesk@ascompinc.in | Website: WWW.ASCOMPINC.IN</div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 28px; font-weight: bold; color: #0066cc; letter-spacing: 2px;">CHRISTIE</div>
                    <div style="font-size: 14px; margin-top: 10px;">Projector Service Report - First done on Date - 2024-01-15</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div style="border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                        <div><strong>Site:</strong> Sample Cinema</div>
                        <div><strong>Personnel:</strong></div>
                        <div style="margin-left: 15px;">Site In-charge: Mr. John Doe - +91-9876543210</div>
                        <div style="margin-left: 15px;">Ascomp Engineer: Jane Smith</div>
                    </div>
                    <div style="border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                        <div><strong>Projector Information:</strong></div>
                        <div style="margin-left: 15px;">Model: CP4325-RGB</div>
                        <div style="margin-left: 15px;">Serial Number: SN123456789</div>
                        <div style="margin-left: 15px;">Software Version: 1.2.3</div>
                        <div style="margin-left: 15px;">Projector running hours: 5000</div>
                        <div><strong>Lamp Information:</strong></div>
                        <div style="margin-left: 15px;">Lamp Model: LMP-2000</div>
                        <div style="margin-left: 15px;">Lamp running hours: 2000</div>
                        <div style="margin-left: 15px;">Current Lamp Hours: 2000</div>
                        <div style="margin-left: 15px;">Replacement Required: No</div>
                    </div>
                </div>
                
                <div style="font-weight: bold; margin: 20px 0 10px 0; font-size: 14px; border-bottom: 2px solid #000; padding-bottom: 5px; text-transform: uppercase;">SECTIONS</div>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="border: 1px solid #000; padding: 8px; text-align: center;">SECTIONS</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center;">DESCRIPTION</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center;">STATUS</th>
                            <th style="border: 1px solid #000; padding: 8px; text-align: center;">YES/NO - OK</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px; background: #f0f0f0; font-weight: bold; text-align: center;">OPTICALS</td>
                            <td style="border: 1px solid #000; padding: 8px;">Reflector</td>
                            <td style="border: 1px solid #000; padding: 8px;">Good</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center; color: #28a745; font-weight: bold;">OK</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;"></td>
                            <td style="border: 1px solid #000; padding: 8px;">UV filter</td>
                            <td style="border: 1px solid #000; padding: 8px;">Good</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center; color: #28a745; font-weight: bold;">OK</td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9;">
                    <div style="margin-bottom: 8px;"><strong>LE Status During PM:</strong> Normal</div>
                    <div style="margin-bottom: 8px;"><strong>AC Status:</strong> Good</div>
                    <div style="margin-bottom: 8px;"><strong>Review Photos:</strong> <span style="color: #0066cc; text-decoration: underline;">Click Here.</span></div>
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc; font-style: italic;">
                        <strong>Note:</strong> The ODD file number is BEFORE and EVEN file number is AFTER, PM
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample FSE report data
        const sampleReportData = {
            reportNumber: 'TEST-REPORT-001',
            reportTitle: 'Test Service Report',
            reportType: 'First',
            date: new Date().toISOString().split('T')[0],
            siteName: 'Test Cinema',
            projectorSerial: 'TEST123456',
            projectorModel: 'CP4325-RGB',
            brand: 'Christie',
            engineer: {
                name: 'Test Engineer',
                phone: '+91-9876543210',
                email: 'engineer@test.com'
            },
            workPerformed: 'Routine maintenance and cleaning performed',
            issuesFound: ['Minor dust accumulation'],
            partsUsed: ['Air filter'],
            recommendations: 'Schedule next maintenance in 3 months',
            photos: [],
            serviceStartTime: new Date().toISOString(),
            serviceEndTime: new Date().toISOString()
        };

        // Sample ASCOMP report data with comprehensive sections
        const sampleASCOMPReportData = {
            reportNumber: 'ASCOMP-REPORT-001',
            reportTitle: 'ASCOMP Service Report',
            reportType: 'First',
            date: new Date().toISOString().split('T')[0],
            siteName: 'Sample Cinema',
            projectorSerial: 'SN123456789',
            projectorModel: 'CP4325-RGB',
            brand: 'Christie',
            softwareVersion: '1.2.3',
            projectorRunningHours: '5000',
            lampModel: 'LMP-2000',
            lampRunningHours: '2000',
            currentLampHours: '2000',
            replacementRequired: false,
            engineer: {
                name: 'Jane Smith',
                phone: '+91-9876543210',
                email: 'jane.smith@ascompinc.in'
            },
            siteIncharge: {
                name: 'John Doe',
                contact: '+91-9876543210'
            },
            sections: {
                opticals: [
                    { description: 'Reflector', status: 'Good', result: 'OK' },
                    { description: 'UV filter', status: 'Good', result: 'OK' },
                    { description: 'Integrator Rod', status: 'Good', result: 'OK' },
                    { description: 'Cold Mirror', status: 'Good', result: 'OK' },
                    { description: 'Fold Mirror', status: 'Good', result: 'OK' }
                ],
                electronics: [
                    { description: 'Touch Panel', status: 'Good', result: 'OK' },
                    { description: 'EVB Board', status: 'Good', result: 'OK' },
                    { description: 'IMCB Board/s', status: 'Good', result: 'OK' },
                    { description: 'PIB Board', status: 'Good', result: 'OK' },
                    { description: 'ICP Board', status: 'Good', result: 'OK' },
                    { description: 'IMB/S Board', status: 'Good', result: 'OK' }
                ],
                mechanical: [
                    { description: 'AC blower', status: 'Good', result: 'OK' },
                    { description: 'Fans', status: 'Good', result: 'OK' },
                    { description: 'Switches', status: 'Good', result: 'OK' },
                    { description: 'Power supply', status: 'Good', result: 'OK' },
                    { description: 'Cooling system', status: 'Good', result: 'OK' }
                ],
                serialNumberVerified: {
                    description: 'Chassis label vs Touch Panel',
                    status: 'Verified',
                    result: 'OK'
                },
                disposableConsumables: [
                    { description: 'Air Intake, LAD and RAD', status: 'Replaced', result: 'OK' },
                    { description: 'Primary filter', status: 'Cleaned', result: 'OK' },
                    { description: 'Secondary filter', status: 'Cleaned', result: 'OK' }
                ],
                coolant: {
                    description: 'Level and Color',
                    status: 'Good',
                    result: 'OK'
                },
                lightEngineTestPatterns: [
                    { color: 'White', status: 'Good', result: 'OK' },
                    { color: 'Red', status: 'Good', result: 'OK' },
                    { color: 'Green', status: 'Good', result: 'OK' },
                    { color: 'Blue', status: 'Good', result: 'OK' },
                    { color: 'Black', status: 'Good', result: 'OK' }
                ]
            },
            imageEvaluation: {
                focusBoresight: 'Yes',
                integratorPosition: 'Yes',
                spotOnScreen: 'No',
                screenCropping: 'Yes',
                convergenceChecked: 'Yes',
                channelsChecked: 'Yes',
                pixelDefects: 'No',
                imageVibration: 'No',
                liteLoc: 'No'
            },
            voltageParameters: {
                pVsN: '230V',
                pVsE: '230V',
                nVsE: '0V'
            },
            contentPlayingServer: 'Server 01',
            lampPowerMeasurements: {
                flBeforePM: '14.5',
                flAfterPM: '14.8'
            },
            environmentStatus: {
                projectorPlacement: 'Good',
                room: 'Good',
                environment: 'Good'
            },
            observations: [
                { number: 1, description: 'Minor dust accumulation found and cleaned' },
                { number: 2, description: 'All systems functioning normally' },
                { number: 3, description: 'Color calibration performed' },
                { number: 4, description: 'Filter replacement completed' }
            ],
            airPollutionLevel: {
                hcho: '0.02',
                tvoc: '0.15',
                pm1: '10',
                pm25: '15',
                pm10: '20',
                overall: 'Good'
            },
            environmentalConditions: {
                temperature: '22°C',
                humidity: '45%'
            },
            systemStatus: {
                leStatus: 'Normal',
                acStatus: 'Good'
            },
            workPerformed: 'Complete preventive maintenance including optical cleaning, filter replacement, color calibration, and system diagnostics',
            issuesFound: [
                'Minor dust accumulation in air intake',
                'Slight color drift detected and corrected'
            ],
            partsUsed: [
                'Primary air filter - Part #AF-001',
                'Secondary air filter - Part #AF-002',
                'Cleaning solution - Part #CS-001'
            ],
            recommendations: 'Schedule next maintenance in 3 months. Monitor color accuracy closely as lamp approaches end of life.',
            measuredColorCoordinates: [
                { testPattern: 'White', fl: '14.8', x: '0.312', y: '0.329' },
                { testPattern: 'Red', fl: '4.2', x: '0.680', y: '0.320' },
                { testPattern: 'Green', fl: '5.1', x: '0.210', y: '0.710' },
                { testPattern: 'Blue', fl: '1.8', x: '0.150', y: '0.060' }
            ],
            cieColorAccuracy: [
                { testPattern: 'White', x: '0.312', y: '0.329', fl: '14.8' },
                { testPattern: 'Red', x: '0.680', y: '0.320', fl: '4.2' },
                { testPattern: 'Green', x: '0.210', y: '0.710', fl: '5.1' }
            ],
            screenInfo: {
                scope: { height: '12.5', width: '26.0', gain: '1.2' },
                flat: { height: '12.5', width: '22.3', gain: '1.2' },
                screenMake: 'Screen Tech Pro',
                throwDistance: '15.2m'
            },
            photos: [
                { filename: 'before_01.jpg', category: 'Before Service', description: 'Projector before maintenance' },
                { filename: 'during_01.jpg', category: 'During Service', description: 'Filter replacement process' },
                { filename: 'after_01.jpg', category: 'After Service', description: 'Projector after maintenance' }
            ],
            signatures: {
                engineer: {
                    name: 'Jane Smith',
                    signedAt: new Date(),
                    dataURI: ''
                },
                customer: {
                    name: 'John Doe',
                    signedAt: new Date(),
                    dataURI: ''
                }
            },
            serviceStartTime: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 hours ago
            serviceEndTime: new Date().toISOString()
        };

        async function testBasicPDFGeneration() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '<div style="color: blue;">Generating PDF...</div>';
            
            try {
                console.log('🔍 Debugging PDF generation...');
                console.log('jsPDF available:', typeof window.jspdf);
                console.log('html2canvas available:', typeof html2canvas);
                
                await generatePDF(sampleReportData, 'Basic FSE Report');
                resultDiv.innerHTML = '<div class="success">✅ Basic PDF generation successful!</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
                console.error('PDF generation error:', error);
                console.error('Error stack:', error.stack);
            }
        }

        async function testASCOMPPDFGeneration() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '<div style="color: blue;">Generating ASCOMP PDF...</div>';
            
            try {
                await generatePDF(sampleASCOMPReportData, 'ASCOMP Service Report');
                resultDiv.innerHTML = '<div class="success">✅ ASCOMP PDF generation successful!</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
                console.error('PDF generation error:', error);
            }
        }

        async function generatePDF(reportData, title) {
            // Check if libraries are available
            if (typeof window.jspdf === 'undefined') {
                throw new Error('jsPDF library not loaded');
            }
            if (typeof html2canvas === 'undefined') {
                throw new Error('html2canvas library not loaded');
            }
            
            const { jsPDF } = window.jspdf;
            console.log('Libraries loaded:', { jsPDF: !!jsPDF, html2canvas: !!html2canvas });
            
            // Create a temporary container for the HTML content
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = document.getElementById('report-preview').innerHTML;
            
            // Hide the container from view
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '-9999px';
            document.body.appendChild(tempContainer);

            try {
                // Wait a bit for the DOM to be ready
                await new Promise(resolve => setTimeout(resolve, 100));

                // Convert HTML to canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 1.5,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 794, // A4 width in pixels at 96 DPI
                    height: 1123 // A4 height in pixels at 96 DPI
                });

                // Remove temporary container
                document.body.removeChild(tempContainer);

                // Create PDF
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Calculate dimensions to fit the page
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                // Add first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Generate filename
                const filename = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;

                // Download the PDF
                pdf.save(filename);
                
                console.log('PDF generated successfully:', filename);
            } catch (error) {
                // Clean up in case of error
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
                throw error;
            }
        }
    </script>
</body>
</html>
