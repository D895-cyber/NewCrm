<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Camera Test - Photo Capture & Cloudinary Upload</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .camera-container { margin: 20px 0; }
        video { 
            width: 100%; 
            max-width: 500px; 
            border: 2px solid #ddd; 
            border-radius: 10px;
            display: block;
            margin: 0 auto;
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            font-size: 16px; 
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        .btn-secondary:hover { background: #545b62; }
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { 
            background: #dc3545; 
            color: white; 
        }
        .btn-danger:hover { background: #c82333; }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover { background: #e0a800; }
        .captured-image { margin: 20px 0; }
        img { 
            max-width: 100%; 
            border: 2px solid #ddd; 
            border-radius: 10px;
        }
        .debug { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 15px 0; 
            font-family: monospace; 
            border-radius: 8px;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .photo-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status-pending { background: #ffc107; color: #212529; }
        .status-uploading { background: #17a2b8; color: white; }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }
        .browser-info {
            background: #e2e3e5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Fixed Camera Test - Photo Capture & Cloudinary Upload</h1>
            <p>Enhanced camera detection with fallback options and Cloudinary integration</p>
        </div>

        <!-- Browser Information -->
        <div class="test-section">
            <h2>üåê Browser & Device Information</h2>
            <div class="browser-info" id="browserInfo">
                Loading browser information...
            </div>
        </div>

        <!-- Test Configuration -->
        <div class="test-section">
            <h2>‚öôÔ∏è Test Configuration</h2>
            <div class="form-group">
                <label for="visitId">Test Visit ID:</label>
                <input type="text" id="visitId" value="TEST-VISIT-001" placeholder="Enter test visit ID">
            </div>
            <div class="form-group">
                <label for="category">Photo Category:</label>
                <select id="category">
                    <option value="Before Service">Before Service</option>
                    <option value="During Service">During Service</option>
                    <option value="After Service">After Service</option>
                    <option value="Issue Found">Issue Found</option>
                    <option value="Parts Replacement">Parts Replacement</option>
                    <option value="Quality Check">Quality Check</option>
                </select>
            </div>
        </div>

        <!-- Camera Test -->
        <div class="test-section">
            <h2>üì∑ Camera Test</h2>
            <div class="camera-container">
                <button id="startCamera" class="btn-primary">Start Camera</button>
                <button id="stopCamera" class="btn-secondary" disabled>Stop Camera</button>
                <button id="capturePhoto" class="btn-success" disabled>Capture Photo</button>
                <button id="testLegacyCamera" class="btn-warning">Test Legacy Camera</button>
            </div>

            <div id="videoContainer" style="display: none;">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>

            <div id="cameraError" class="error-message" style="display: none;"></div>
            <div id="cameraWarning" class="warning-message" style="display: none;"></div>
            <div id="cameraInfo" class="info-message" style="display: none;"></div>
        </div>

        <!-- File Upload -->
        <div class="test-section">
            <h2>üìÅ File Upload</h2>
            <div class="form-group">
                <label for="fileUpload">Select Photos:</label>
                <input type="file" id="fileUpload" accept="image/*" multiple>
            </div>
            <p><small>You can also upload existing image files to test Cloudinary integration</small></p>
        </div>

        <!-- Photos Display -->
        <div id="photosSection" class="test-section" style="display: none;">
            <h2>üñºÔ∏è Captured Photos</h2>
            <div id="uploadProgress" style="display: none;">
                <h3>Upload Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p id="progressText">0%</p>
            </div>
            
            <button id="uploadToCloudinary" class="btn-success">Upload to Cloudinary</button>
            <button id="clearPhotos" class="btn-danger">Clear All Photos</button>
            
            <div id="photosGrid" class="photo-grid"></div>
        </div>

        <!-- Debug Information -->
        <div class="test-section">
            <h2>üîç Debug Information</h2>
            <button id="clearDebug" class="btn-secondary">Clear Debug Info</button>
            <div id="debugInfo" class="debug">
                <div>No debug information yet...</div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="test-section">
            <h2>üìã Testing Instructions</h2>
            <ol>
                <li><strong>Browser Check:</strong> Review browser and device information above</li>
                <li><strong>Camera Test:</strong> Try "Start Camera" first, then "Test Legacy Camera" if needed</li>
                <li><strong>Photo Capture:</strong> Use "Capture Photo" button to take pictures</li>
                <li><strong>File Upload:</strong> Select existing image files to test</li>
                <li><strong>Cloudinary Upload:</strong> Click "Upload to Cloudinary" to test backend integration</li>
                <li><strong>Debug Info:</strong> Check the debug section for detailed information</li>
            </ol>
        </div>
    </div>

    <script>
        // Global variables
        let currentStream = null;
        let photos = [];
        let isUploading = false;
        let cameraSupport = 'unknown';

        // DOM elements
        const startBtn = document.getElementById('startCamera');
        const stopBtn = document.getElementById('stopCamera');
        const captureBtn = document.getElementById('capturePhoto');
        const testLegacyBtn = document.getElementById('testLegacyCamera');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const videoContainer = document.getElementById('videoContainer');
        const cameraError = document.getElementById('cameraError');
        const cameraWarning = document.getElementById('cameraWarning');
        const cameraInfo = document.getElementById('cameraInfo');
        const fileUpload = document.getElementById('fileUpload');
        const photosSection = document.getElementById('photosSection');
        const photosGrid = document.getElementById('photosGrid');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadBtn = document.getElementById('uploadToCloudinary');
        const clearPhotosBtn = document.getElementById('clearPhotos');
        const clearDebugBtn = document.getElementById('clearDebug');
        const debugInfo = document.getElementById('debugInfo');
        const visitIdInput = document.getElementById('visitId');
        const categorySelect = document.getElementById('category');
        const browserInfo = document.getElementById('browserInfo');

        // Debug logging
        function log(message) {
            const time = new Date().toLocaleTimeString();
            const debugDiv = document.createElement('div');
            debugDiv.textContent = `[${time}] ${message}`;
            debugInfo.appendChild(debugDiv);
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(message);
        }

        // Get browser information
        function getBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                vendor: navigator.vendor,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                secureContext: window.isSecureContext,
                mediaDevices: !!navigator.mediaDevices,
                getUserMedia: !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia),
                permissions: !!navigator.permissions
            };
            
            let infoHtml = '<strong>Browser Information:</strong><br>';
            for (const [key, value] of Object.entries(info)) {
                infoHtml += `${key}: ${value}<br>`;
            }
            
            browserInfo.innerHTML = infoHtml;
            return info;
        }

        // Check camera support with detailed analysis
        function checkCameraSupport() {
            log('=== Checking Camera Support ===');
            
            const browserInfo = getBrowserInfo();
            log(`Secure context: ${browserInfo.secureContext}`);
            log(`MediaDevices available: ${browserInfo.mediaDevices}`);
            log(`Legacy getUserMedia available: ${browserInfo.getUserMedia}`);
            log(`Permissions API available: ${browserInfo.permissions}`);
            
            // Check secure context
            if (!browserInfo.secureContext) {
                log('‚ö†Ô∏è Not in secure context - camera may not work');
                showCameraWarning('Not in secure context (HTTPS required for camera access)');
            }
            
            // Check for modern mediaDevices API
            if (browserInfo.mediaDevices && navigator.mediaDevices.getUserMedia) {
                log('‚úÖ Modern camera API (mediaDevices.getUserMedia) available');
                cameraSupport = 'modern';
                return 'modern';
            }
            
            // Check for legacy getUserMedia
            if (browserInfo.getUserMedia) {
                log('‚ö†Ô∏è Legacy camera API available (getUserMedia)');
                cameraSupport = 'legacy';
                showCameraWarning('Using legacy camera API - some features may be limited');
                return 'legacy';
            }
            
            // No camera support
            log('‚ùå No camera API support found');
            cameraSupport = 'none';
            showCameraError('No camera API support found on this device/browser. Please use a modern browser with camera support.');
            return 'none';
        }

        // Show camera error
        function showCameraError(message) {
            cameraError.textContent = message;
            cameraError.style.display = 'block';
            cameraWarning.style.display = 'none';
            cameraInfo.style.display = 'none';
        }

        // Show camera warning
        function showCameraWarning(message) {
            cameraWarning.textContent = message;
            cameraWarning.style.display = 'block';
            cameraError.style.display = 'none';
            cameraInfo.style.display = 'none';
        }

        // Show camera info
        function showCameraInfo(message) {
            cameraInfo.textContent = message;
            cameraInfo.style.display = 'block';
            cameraError.style.display = 'none';
            cameraWarning.style.display = 'none';
        }

        // Hide all camera messages
        function hideCameraMessages() {
            cameraError.style.display = 'none';
            cameraWarning.style.display = 'none';
            cameraInfo.style.display = 'none';
        }

        // Legacy getUserMedia function
        function getLegacyUserMedia(constraints) {
            return new Promise((resolve, reject) => {
                const getUserMedia = navigator.getUserMedia || 
                                   navigator.webkitGetUserMedia || 
                                   navigator.mozGetUserMedia || 
                                   navigator.msGetUserMedia;
                
                if (getUserMedia) {
                    getUserMedia.call(navigator, constraints, resolve, reject);
                } else {
                    reject(new Error('Legacy getUserMedia not available'));
                }
            });
        }

        // Start camera with modern API
        startBtn.addEventListener('click', async () => {
            if (cameraSupport === 'none') {
                log('Cannot start camera - no support available');
                return;
            }
            
            try {
                log('=== Starting Camera (Modern API) ===');
                hideCameraMessages();
                
                // Try different camera configurations
                const configs = [
                    { video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } },
                    { video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } },
                    { video: { width: { min: 640 }, height: { min: 480 } } },
                    { video: true }
                ];

                let stream = null;
                let configIndex = 0;

                while (!stream && configIndex < configs.length) {
                    try {
                        log(`Trying camera config ${configIndex + 1}: ${JSON.stringify(configs[configIndex])}`);
                        
                        if (cameraSupport === 'modern') {
                            stream = await navigator.mediaDevices.getUserMedia(configs[configIndex]);
                        } else {
                            stream = await getLegacyUserMedia(configs[configIndex]);
                        }
                        
                        log(`‚úÖ Camera started with config ${configIndex + 1}`);
                    } catch (err) {
                        log(`‚ùå Config ${configIndex + 1} failed: ${err.name} - ${err.message}`);
                        configIndex++;
                    }
                }

                if (!stream) {
                    throw new Error('All camera configurations failed');
                }

                // Store stream globally
                currentStream = stream;
                
                video.srcObject = stream;
                videoContainer.style.display = 'block';
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                captureBtn.disabled = false;
                
                log('üéâ Camera started successfully');
                showCameraInfo('Camera started successfully! You can now capture photos.');
                
            } catch (error) {
                log(`‚ùå Camera error: ${error.name} - ${error.message}`);
                
                let errorMessage = 'Unable to access camera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please grant camera permissions and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Camera is in use by another application.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'Camera constraints not supported.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Camera not supported on this device.';
                } else if (error.name === 'TypeError') {
                    errorMessage += 'Camera API not available. Please use a modern browser.';
                } else {
                    errorMessage += `Error: ${error.message}`;
                }
                
                showCameraError(errorMessage);
            }
        });

        // Test legacy camera
        testLegacyBtn.addEventListener('click', async () => {
            if (cameraSupport === 'none') {
                log('Cannot test legacy camera - no support available');
                return;
            }
            
            try {
                log('=== Testing Legacy Camera API ===');
                hideCameraMessages();
                
                const constraints = { video: true };
                log('Trying legacy getUserMedia with basic constraints');
                
                const stream = await getLegacyUserMedia(constraints);
                log('‚úÖ Legacy camera API working!');
                
                // Store stream globally
                currentStream = stream;
                
                video.srcObject = stream;
                videoContainer.style.display = 'block';
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                captureBtn.disabled = false;
                
                showCameraInfo('Legacy camera API working! You can now capture photos.');
                
            } catch (error) {
                log(`‚ùå Legacy camera error: ${error.name} - ${error.message}`);
                showCameraError(`Legacy camera failed: ${error.message}`);
            }
        });

        // Stop camera
        stopBtn.addEventListener('click', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    log(`Stopped track: ${track.kind}`);
                });
                currentStream = null;
            }
            
            video.srcObject = null;
            videoContainer.style.display = 'none';
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            captureBtn.disabled = true;
            
            log('Camera stopped');
            hideCameraMessages();
        });

        // Capture photo
        captureBtn.addEventListener('click', () => {
            if (!video.videoWidth || !video.videoHeight) {
                log('Video not ready yet');
                return;
            }

            log('Capturing photo...');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            canvas.toBlob((blob) => {
                if (blob) {
                    log(`Photo captured: ${blob.size} bytes`);
                    const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    addPhoto(file, `Camera Photo - ${new Date().toLocaleString()}`);
                } else {
                    log('Failed to create photo blob');
                }
            }, 'image/jpeg', 0.8);
        });

        // Handle file upload
        fileUpload.addEventListener('change', (event) => {
            const files = Array.from(event.target.files || []);
            log(`File upload: ${files.length} files selected`);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    log(`Processing image: ${file.name} (${file.size} bytes)`);
                    addPhoto(file, file.name);
                } else {
                    log(`Skipping non-image file: ${file.name}`);
                }
            });
        });

        // Add photo to collection
        function addPhoto(file, description) {
            const photo = {
                id: Date.now() + Math.random(),
                file: file,
                description: description,
                category: categorySelect.value,
                status: 'pending',
                preview: URL.createObjectURL(file)
            };
            
            photos.push(photo);
            updatePhotosDisplay();
            log(`Photo added: ${description}`);
        }

        // Update photos display
        function updatePhotosDisplay() {
            if (photos.length === 0) {
                photosSection.style.display = 'none';
                return;
            }
            
            photosSection.style.display = 'block';
            photosGrid.innerHTML = '';
            
            photos.forEach(photo => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                photoItem.innerHTML = `
                    <img src="${photo.preview}" alt="${photo.description}">
                    <div>
                        <strong>${photo.description}</strong><br>
                        <span class="status-badge status-${photo.status}">${photo.status}</span>
                        ${photo.cloudinaryUrl ? '<br><small>‚úÖ Uploaded to Cloudinary</small>' : ''}
                        ${photo.error ? '<br><small class="error-message">‚ùå ' + photo.error + '</small>' : ''}
                    </div>
                `;
                
                photosGrid.appendChild(photoItem);
            });
        }

        // Upload to Cloudinary
        async function uploadToCloudinary(photo) {
            try {
                log(`Uploading ${photo.description} to Cloudinary...`);
                
                const formData = new FormData();
                formData.append('file', photo.file);
                formData.append('upload_preset', 'projectorcare');
                formData.append('cloud_name', 'dxepnpgw7');
                formData.append('folder', `fse-photos/${visitIdInput.value}/${categorySelect.value}`);

                const response = await fetch('https://api.cloudinary.com/v1_1/dxepnpgw7/image/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Cloudinary upload failed: ${response.statusText}`);
                }

                const result = await response.json();
                log(`Upload successful: ${result.secure_url}`);
                
                return result.secure_url;
            } catch (error) {
                log(`Upload failed: ${error.message}`);
                throw error;
            }
        }

        // Upload all photos
        uploadBtn.addEventListener('click', async () => {
            if (photos.length === 0) {
                alert('No photos to upload');
                return;
            }

            if (isUploading) return;
            
            isUploading = true;
            uploadBtn.disabled = true;
            uploadProgress.style.display = 'block';
            
            log(`Starting upload of ${photos.length} photos to Cloudinary`);

            try {
                // Update all photos to uploading status
                photos.forEach(photo => photo.status = 'uploading');
                updatePhotosDisplay();

                // Upload each photo individually
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    try {
                        const cloudinaryUrl = await uploadToCloudinary(photo);
                        photo.status = 'success';
                        photo.cloudinaryUrl = cloudinaryUrl;
                        log(`Photo ${i + 1}/${photos.length} uploaded successfully`);
                    } catch (error) {
                        photo.status = 'error';
                        photo.error = error.message;
                        log(`Photo ${i + 1}/${photos.length} upload failed: ${error.message}`);
                    }
                    
                    // Update progress
                    const progress = ((i + 1) / photos.length) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    
                    updatePhotosDisplay();
                }

                log('All uploads completed');
                alert(`Upload completed! Check debug info for details.`);

            } catch (error) {
                log(`Upload process failed: ${error.message}`);
                alert(`Upload failed: ${error.message}`);
            } finally {
                isUploading = false;
                uploadBtn.disabled = false;
                uploadProgress.style.display = 'none';
            }
        });

        // Clear photos
        clearPhotosBtn.addEventListener('click', () => {
            photos.forEach(photo => URL.revokeObjectURL(photo.preview));
            photos = [];
            updatePhotosDisplay();
            log('All photos cleared');
        });

        // Clear debug info
        clearDebugBtn.addEventListener('click', () => {
            debugInfo.innerHTML = '<div>Debug info cleared...</div>';
        });

        // Initialize
        log('=== Fixed Camera Test Page Loaded ===');
        log('Checking camera support...');
        checkCameraSupport();
    </script>
</body>
</html>

